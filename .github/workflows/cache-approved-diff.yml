# A workflow to cache snapshots of approved diffs.
# These snapshots are used by dismiss-if-stale-review.

name: Cache approved diff
on:  # specify when to trigger the workflow
  # the events and their specification can be found at
  # https://docs.github.com/en/webhooks-and-events/webhooks/webhook-events-and-payloads

  # watch for PR approval to cache a snapshot of the reviewed diff
  pull_request_review:
    types: [submitted]
jobs:
  # Take a snapshot of the diff when a PR is approved so we can compare against it
  # later.
  snapshot-approved-diff:
    runs-on: ubuntu-latest
    # run if this is a PR approval
    if: ${{ github.event.review.state == 'APPROVED' }}
    permissions:  # permissions to check for approval and get the diff
      contents: read
      pull-requests: read
    steps:
      # Get the merge base for range-diff comparison
      - name: Get merge base
        id: merge-base
        run: |
          MERGE_BASE=$(gh api \
            /repos/${{ github.repository }}/compare/${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} \
            --jq '.merge_base_commit.sha')
          echo "sha=$MERGE_BASE" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create metadata JSON for range-diff comparison
      - name: Create approval metadata
        run: |
          cat > approval-metadata.json << EOF
          {
            "version": 1,
            "review_id": "${{ github.event.review.id }}",
            "approved_sha": "${{ github.event.review.commit_id }}",
            "merge_base_sha": "${{ steps.merge-base.outputs.sha }}",
            "base_sha": "${{ github.event.pull_request.base.sha }}",
            "base_ref": "${{ github.event.pull_request.base.ref }}",
            "approved_at": "${{ github.event.review.submitted_at }}"
          }
          EOF

      # Get the diff using gh CLI (for fallback comparison)
      - name: Get approved diff
        run: >
          gh api -H 'Accept: application/vnd.github.diff'
          /repos/${{ github.repository }}/compare/${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} > approved.diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Cache both files together. The cache is scoped to the current branch and the "default"
      # branch aka develop.
      - uses: actions/cache/save@v3
        with:
          path: |
            approval-metadata.json
            approved.diff
          # Key by review ID - this is immutable even after force pushes
          # (unlike commit SHA which GitHub updates on the review object)
          key: approval-${{ github.event.review.id }}
